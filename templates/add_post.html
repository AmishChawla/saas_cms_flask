{% if current_user.role == "user" %}
    {% extends 'base.html' %}
{% else %}
    {% extends 'admin_base.html' %}
{% endif %}

{% block title %}Add Post{% endblock %}

{% block content %}

<style>
    .tags-container {
    display: flex;
    flex-wrap: wrap;
    margin-top: 10px;
}

.tag {
    background-color: #f0f0f0;
    padding: 5px 10px;
    margin-right: 5px;
    margin-bottom: 5px;
    border-radius: 3px;
    cursor: pointer;
}

.close-button {
    margin-left: 5px;
    background: none;
    border: none;
    cursor: pointer;
}
</style>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card border-0">
                    <div class="card-header bg-white text-black text-center">
                        <h2>Add Post</h2>
                    </div>

                    <div class="card-body">


                        <form method="post" action="{{ url_for('add_post') }}">
                            {{ form.hidden_tag() }}

                            <div class="mb-3">
                                {{form.title.label}}
                                {{ form.title(class="form-control", placeholder="Title", required=True) }}
                            </div>

                            <div class="mb-3">
                                {{ form.category.label }}
                                {{ form.category(class="form-control", id="category", required=True) }}
                            </div>

                            <div class="mb-3">
                                {{ form.subcategory.label }}
                                {{ form.subcategory(class="form-control", id="subcategory", required=True) }}
                            </div>
                            <div class="mb-3">
                                {{ form.tags.label }}
                                <!-- New dynamic tags input -->
                                <textarea name="dynamic_tags" class="form-control" rows="3" placeholder="Enter tags separated by commas..."></textarea>
                            </div>

                            <div class="mb-3">
                                {{ form.content.label }}
                                {{ form.content(class="form-control", id="content", placeholder="Write details about the post.") }}
                            </div>

                            <div class="mb-3 text-center">
                                {{ form.submit(class="btn btn-dark btn-lg") }}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.ckeditor.com/4.16.2/standard-all/ckeditor.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dynamicTagsInput = document.querySelector('[name="dynamic_tags"]');
        const tagsContainer = document.createElement('div');
        tagsContainer.classList.add('tags-container');

        dynamicTagsInput.addEventListener('input', function () {
            const tags = dynamicTagsInput.value.split(',').map(tag => tag.trim());
            tagsContainer.innerHTML = ''; // Clear existing tags

            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.classList.add('tag');
                tagElement.textContent = tag;
                tagElement.addEventListener('click', function () {
                    tags.splice(tags.indexOf(tag), 1);
                    dynamicTagsInput.value = tags.join(',');
                    updateTagsDisplay();
                });

                const closeButton = document.createElement('button');
                closeButton.classList.add('close-button');
                closeButton.textContent = 'Ã—';
                closeButton.addEventListener('click', function () {
                    tags.splice(tags.indexOf(tag), 1);
                    dynamicTagsInput.value = tags.join(',');
                    updateTagsDisplay();
                });

                tagElement.appendChild(closeButton);
                tagsContainer.appendChild(tagElement);
            });

            updateTagsDisplay();
        });

        function updateTagsDisplay() {
            const tags = dynamicTagsInput.value.split(',').map(tag => tag.trim());
            tagsContainer.innerHTML = '';
            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.classList.add('tag');
                tagElement.textContent = tag;
                tagsContainer.appendChild(tagElement);
            });
        }

        dynamicTagsInput.parentNode.insertBefore(tagsContainer, dynamicTagsInput.nextSibling);

        // Initial display of any pre-existing tags
        updateTagsDisplay();
    });
</script>

    <script>
        // Replace the CKEditor instance with the correct ID
        CKEDITOR.replace('content');

document.addEventListener('DOMContentLoaded', function () {
        const categoryElement = document.getElementById('category');
        const subcategoryElement = document.getElementById('subcategory');

        categoryElement.addEventListener('change', function () {
            const selectedCategoryId = this.value;

            if (selectedCategoryId) {
                fetch(`/subcategories/${selectedCategoryId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log('Fetched subcategories:', data); // Debugging line
                        // Clear existing subcategory options
                        subcategoryElement.innerHTML = '<option value="">Select a subcategory</option>';

                        // Populate new subcategory options
                        data.subcategories.forEach(subcategory => {
                            const option = document.createElement('option');
                            option.value = subcategory.id;
                            option.textContent = subcategory.subcategory;
                            subcategoryElement.appendChild(option);
                        });
                    })
                    .catch(error => console.error('Error fetching subcategories:', error));
            } else {
                subcategoryElement.innerHTML = '<option value="">Select a subcategory</option>';
            }
        });
    });
    </script>
{% endblock %}
